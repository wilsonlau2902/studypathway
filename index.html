<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wai Ming's Pathway | DDP (CS + Finance)</title>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- PDF.js for Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .course-card { transition: all 0.2s; }
        .course-card:hover { transform: translateY(-2px); }
        select { background-image: none; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #64748b; font-weight: 500; }
        
        .badge-offered { background-color: #dcfce7; color: #166534; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; border: 1px solid #bbf7d0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Set worker for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const { useState, useEffect, useMemo, useRef } = React;

        // --- DATA CONSTANTS ---
        const STATUS = {
            COMPLETED: 'completed',
            IN_PROGRESS: 'in-progress',
            PLANNED: 'planned',
            NOT_STARTED: 'not-started'
        };

        // --- DEFAULT DATABASES ---
        const DEFAULT_COMP_DB = {
            "AI / Theory": [
                { code: "COMP 3211", name: "Fundamentals of Artificial Intelligence" },
                { code: "COMP 3721", name: "Theory of Computation" },
                { code: "COMP 4211", name: "Machine Learning" },
                { code: "COMP 4221", name: "Intro to Natural Language Processing" },
                { code: "COMP 4331", name: "Data Mining" },
                { code: "COMP 4421", name: "Image Processing" },
                { code: "COMP 4471", name: "Deep Learning in Computer Vision" }
            ],
            "Systems / Networking": [
                { code: "COMP 3631", name: "Cryptography" },
                { code: "COMP 4511", name: "System and Kernel Programming in Linux" },
                { code: "COMP 4611", name: "Design and Analysis of Computer Architectures" },
                { code: "COMP 4621", name: "Computer and Communication Networks" },
                { code: "COMP 4634", name: "Cybersecurity" },
                { code: "COMP 4651", name: "Cloud Computing and Big Data Systems" }
            ],
            "Software / Database": [
                { code: "COMP 3021", name: "Java Programming" },
                { code: "COMP 3311", name: "Database Management Systems" },
                { code: "COMP 4021", name: "Internet Computing" }
            ],
            "Vision / Graphics": [
                { code: "COMP 4411", name: "Computer Graphics" },
                { code: "COMP 4461", name: "Human-Computer Interaction" }
            ],
            "Other": []
        };

        const DEFAULT_FINA_DB = {
            "Corporate Finance": [
                { code: "FINA 4013", name: "Corporate Valuation" },
                { code: "FINA 4203", name: "Mergers, Acquisitions, and Corporate Restructuring" },
                { code: "FINA 4603", name: "Venture Capital Financing" }
            ],
            "Investments": [
                { code: "FINA 4303", name: "Fixed Income Securities" },
                { code: "FINA 4513", name: "Risk Management" }
            ],
            "FinTech": [
                { code: "FINA 4703", name: "ESG Investing" },
                { code: "FINA 4713", name: "Intro to AI and Big Data in Finance" }
            ],
            "Other": []
        };

        const initialData = {
            studentName: "LAU, Wai Ming",
            studentId: "21011686",
            offeredCourses: [],
            courseCatalogs: { COMP: DEFAULT_COMP_DB, FINA: DEFAULT_FINA_DB },
            categories: [
                {
                    id: "common_core",
                    title: "University Common Core (30 Credits)",
                    color: "bg-pink-100 text-pink-800",
                    requirements: [
                        { id: "cc_legal", name: "Legal Education", code: "LEGL 1000", status: STATUS.COMPLETED, grade: "P", note: "Foundations I" },
                        { id: "cc_hmw", name: "Habits, Mindsets & Wellness", code: "HMAW 1905B", status: STATUS.COMPLETED, grade: "P", note: "Foundations I (3 credits)" },
                        { id: "cc_ecomm1", name: "English Comm I", code: "LANG 1402", status: STATUS.COMPLETED, grade: "T", note: "Foundations I - E-Comm (3 credits)" },
                        { id: "cc_ecomm2", name: "English Comm II", code: "LANG 1404", status: STATUS.COMPLETED, grade: "A-", note: "Foundations I - E-Comm (3 credits)" },
                        { id: "cc_ccomm", name: "Chinese Comm (C-Comm)", code: "LANG 1113", status: STATUS.NOT_STARTED, note: "Foundations I (3 credits needed)" },
                        { id: "cc_arts", name: "Arts (A) - Broadening", code: "CORE BROAD", status: STATUS.COMPLETED, grade: "T", note: "Transfer Credit (3 credits)" },
                        { id: "cc_huma", name: "Humanities (H) - Broadening", code: "CORE BROAD", status: STATUS.COMPLETED, grade: "T", note: "Transfer Credit (3 credits)" },
                        { id: "cc_sci", name: "Science (S) - Broadening", code: "BIEN 1610", status: STATUS.IN_PROGRESS, note: "Broadening (3 credits)" },
                        { id: "cc_broad_4", name: "Broadening Elective (Any Area)", code: "", status: STATUS.NOT_STARTED, type: "text_input", note: "Required 4th Broadening Course (3 credits)" },
                        { id: "cc_ctdl", name: "Critical Thinking & Data Lit (CTDL)", code: "", status: STATUS.NOT_STARTED, type: "text_input", note: "Foundations II (3 credits needed)" },
                        { id: "cc_exp_upop1", name: "UPOP Pre-internship Training", code: "UPOP 1920", status: STATUS.COMPLETED, grade: "P", note: "Experiencing (1 credit)" },
                        { id: "cc_exp_upop2", name: "UG Practice Opportunities", code: "UPOP 2920", status: STATUS.COMPLETED, grade: "P", note: "Experiencing (2 credits)" }
                    ]
                },
                {
                    id: "eng_fund",
                    title: "Engineering Fundamentals",
                    color: "bg-blue-100 text-blue-800",
                    requirements: [
                        { id: "intro_cs", name: "Intro to CS", alternatives: ["COMP 1021", "COMP 1022P"], status: STATUS.COMPLETED, taken: "COMP 1021", grade: "B" },
                        { id: "calc_1", name: "Calculus I", alternatives: ["MATH 1012", "MATH 1013", "MATH 1023"], status: STATUS.COMPLETED, taken: "MATH 1013", grade: "T" },
                        { id: "calc_2", name: "Calculus II", alternatives: ["MATH 1014", "MATH 1024"], status: STATUS.COMPLETED, taken: "MATH 1014", grade: "C-" },
                        { id: "lin_alg", name: "Linear Algebra", alternatives: ["MATH 2111", "MATH 2121", "MATH 2131"], status: STATUS.COMPLETED, taken: "MATH 2111", grade: "C+" },
                        // Merged Science Requirement: PHYS 1101, CHEM 1020, LIFS 1901. One counts here, others go to free electives.
                        { id: "sci_fund", name: "Science Fundamental", alternatives: ["CHEM 1008", "CHEM 1012", "CHEM 1020", "LIFS 1901", "PHYS 1101", "PHYS 1112", "PHYS 1312"], status: STATUS.COMPLETED, taken: "PHYS 1101", grade: "A", note: "Take ONE (3-4 credits). Extras (like CHEM, LIFS) count as Free Electives." },
                        { id: "eng_intro", name: "Engg Intro", alternatives: ["CENG 1500", "ELEC 1100", "MECH 1901"], status: STATUS.COMPLETED, taken: "CENG 1500", grade: "A-", note: "SENG Intro Requirement" },
                        { id: "engg_2010", name: "Engg Seminar", code: "ENGG 2010", status: STATUS.IN_PROGRESS, note: "Engineering requirement" },
                        { id: "tech_comm_1", name: "Tech Comm I", alternatives: ["LANG 2030"], status: STATUS.COMPLETED, note: "Waived for DDP or met by LANG 1404 track" },
                    ]
                },
                {
                    id: "cs_core",
                    title: "Computer Science Core",
                    color: "bg-indigo-100 text-indigo-800",
                    requirements: [
                        { id: "comp_2011", name: "Programming with C++", code: "COMP 2011", status: STATUS.COMPLETED, grade: "C-", prereqs: ["COMP 1021"] },
                        { id: "comp_2012", name: "OOP & Data Structures", code: "COMP 2012", status: STATUS.COMPLETED, grade: "C", prereqs: ["COMP 2011"] },
                        { id: "comp_2611", name: "Computer Organization", code: "COMP 2611", status: STATUS.COMPLETED, grade: "B-", prereqs: ["COMP 1021"] },
                        { id: "comp_2711", name: "Discrete Math Tools", code: "COMP 2711", status: STATUS.COMPLETED, grade: "B-", prereqs: ["MATH 1013"] },
                        { id: "comp_3111", name: "Software Engineering", code: "COMP 3111", status: STATUS.NOT_STARTED, prereqs: ["COMP 2012"] },
                        { id: "comp_3511", name: "Operating Systems", code: "COMP 3511", status: STATUS.NOT_STARTED, prereqs: ["COMP 2611"] },
                        { id: "comp_3711", name: "Algorithms", code: "COMP 3711", status: STATUS.IN_PROGRESS, prereqs: ["COMP 2711", "Calculus"] },
                        { id: "comp_4900", name: "Acad. & Prof. Dev.", code: "COMP 4900", status: STATUS.IN_PROGRESS, note: "Must take every term" },
                        { id: "prob_stat", name: "Probability/Stats", alternatives: ["ELEC 2600", "IEDA 2520", "MATH 2411"], status: STATUS.IN_PROGRESS, taken: "IEDA 2520", note: "MATH 2411 recommended for COMP, but IEDA 2520 accepted" },
                        { id: "fyp", name: "Final Year Project", alternatives: ["COMP 4981", "COMP 4981H", "COMP 4910"], status: STATUS.NOT_STARTED, credits: 6, note: "COMP 4910 (Co-op) satisfies this + Ind. Exp." },
                        { id: "ind_exp", name: "Industrial Experience", code: "COMP 1991", status: STATUS.NOT_STARTED, note: "Or COMP 4910" },
                        { id: "lang_4030", name: "Tech Comm II", code: "LANG 4030", status: STATUS.NOT_STARTED, note: "For CSE/CPEG" }
                    ]
                },
                {
                    id: "cs_electives",
                    title: "CS Electives (5 Courses)",
                    color: "bg-purple-100 text-purple-800",
                    description: "3 from one area, 2 from outside. Areas: AI, Vision, Software, Systems.",
                    requirements: [
                        { id: "elec_1", name: "Elective 1", code: "Select Elective", status: STATUS.NOT_STARTED, type: "dropdown", dbKey: "COMP" },
                        { id: "elec_2", name: "Elective 2", code: "Select Elective", status: STATUS.NOT_STARTED, type: "dropdown", dbKey: "COMP" },
                        { id: "elec_3", name: "Elective 3", code: "Select Elective", status: STATUS.NOT_STARTED, type: "dropdown", dbKey: "COMP" },
                        { id: "elec_4", name: "Elective 4", code: "Select Elective", status: STATUS.NOT_STARTED, type: "dropdown", dbKey: "COMP" },
                        { id: "elec_5", name: "Elective 5", code: "Select Elective", status: STATUS.NOT_STARTED, type: "dropdown", dbKey: "COMP" },
                    ]
                },
                {
                    id: "biz_core",
                    title: "Business Core (Finance)",
                    color: "bg-emerald-100 text-emerald-800",
                    requirements: [
                        { id: "acct_2010", name: "Accounting I", code: "ACCT 2010", status: STATUS.COMPLETED, grade: "B+" },
                        { id: "acct_2200", name: "Accounting II", code: "ACCT 2200", status: STATUS.COMPLETED, grade: "B-" },
                        { id: "econ_2113", name: "Microeconomics", code: "ECON 2113", status: STATUS.COMPLETED, grade: "A" },
                        { id: "econ_2123", name: "Macroeconomics", code: "ECON 2123", status: STATUS.COMPLETED, grade: "B" },
                        { id: "isom_2500", name: "Business Stats", code: "ISOM 2500", status: STATUS.COMPLETED, grade: "B", note: "Or MATH 2411" },
                        { id: "isom_2600", name: "Business Analytics", code: "ISOM 2600", status: STATUS.COMPLETED, grade: "A-" },
                        { id: "isom_2700", name: "Ops Management", code: "ISOM 2700", status: STATUS.COMPLETED, grade: "A-" },
                        { id: "mark_2120", name: "Marketing Mgmt", code: "MARK 2120", status: STATUS.COMPLETED, grade: "A-" },
                        { id: "mgmt_2010", name: "Biz Ethics", code: "MGMT 2010", status: STATUS.COMPLETED, grade: "A" },
                        { id: "mgmt_2110", name: "Org Behavior", code: "MGMT 2110", status: STATUS.COMPLETED, grade: "A+" },
                        { id: "fina_2303", name: "Financial Mgmt", code: "FINA 2303", status: STATUS.COMPLETED, grade: "A" },
                        { id: "bba_comm", name: "BBA Communication", alternatives: ["LANG 2061", "LANG 2062", "LANG 3060"], status: STATUS.NOT_STARTED, note: "School Req (3 credits)" },
                        { id: "mgmt_2130", name: "Biz Ethics & Soc Resp", code: "MGMT 2130", status: STATUS.IN_PROGRESS },
                    ]
                },
                {
                    id: "fina_major",
                    title: "Finance Major Required",
                    color: "bg-teal-100 text-teal-800",
                    requirements: [
                        { id: "fina_3103", name: "Inter. Investments", code: "FINA 3103", status: STATUS.IN_PROGRESS, prereqs: ["FINA 2303"] },
                        { id: "fina_3203", name: "Derivative Securities", code: "FINA 3203", status: STATUS.NOT_STARTED, prereqs: ["FINA 3103"] },
                        { id: "fina_3303", name: "Inter. Corp Finance", code: "FINA 3303", status: STATUS.NOT_STARTED, prereqs: ["FINA 2303"] },
                        { id: "fina_3001", name: "Key Skills Finance", code: "FINA 3001", status: STATUS.IN_PROGRESS },
                        { id: "fina_3810", name: "Bloomberg Cert", code: "FINA 3810", status: STATUS.IN_PROGRESS },
                        { id: "acct_3030", name: "Intermediate Financial Accounting", alternatives: ["ACCT 3030", "ACCT 3010 + ACCT 3020"], status: STATUS.NOT_STARTED, note: "ACCT 3030 for Non-ACCT majors" },
                        { id: "isom_prog", name: "Business Programming", alternatives: ["ISOM 3230", "ISOM 3400", "COMP 1022P"], status: STATUS.NOT_STARTED, note: "Since you took COMP 1021, take one of these." },
                        { id: "fina_elec_1", name: "Finance Elective 1 (3000+)", code: "Select FINA Elective", status: STATUS.NOT_STARTED, type: "dropdown", dbKey: "FINA" },
                        { id: "fina_elec_2", name: "Finance Elective 2 (3000+)", code: "Select FINA Elective", status: STATUS.NOT_STARTED, type: "dropdown", dbKey: "FINA" },
                        { id: "fina_elec_3", name: "Finance Elective 3 (3000+)", code: "Select FINA Elective", status: STATUS.NOT_STARTED, type: "dropdown", dbKey: "FINA" },
                    ]
                },
                {
                    id: "ddp_extras",
                    title: "Dual Degree (T&M) Specifics",
                    color: "bg-orange-100 text-orange-800",
                    requirements: [
                        { id: "temg_1010", name: "T&M Prof Activities", code: "TEMG 1010", status: STATUS.IN_PROGRESS },
                        { id: "temg_3950", name: "Case Analysis", code: "TEMG 3950", status: STATUS.COMPLETED, grade: "B+" },
                        { id: "temg_4950", name: "Capstone Project", code: "TEMG 4950", status: STATUS.NOT_STARTED },
                    ]
                },
                {
                    id: "free_electives",
                    title: "Free Electives / Unused Courses",
                    color: "bg-gray-100 text-gray-800",
                    description: "Courses taken that don't fit major requirements but count towards 120 credits. (e.g. SBMT6020G, MGMT3140)",
                    requirements: [] // Auto-filled by transcript
                }
            ]
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState("tracker"); 
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem('my_pathway_data_v15');
                if (saved) return JSON.parse(saved);
                return initialData;
            });
            const [isProcessing, setIsProcessing] = useState(false);
            const [processStatus, setProcessStatus] = useState("");
            const [report, setReport] = useState(null);
            
            useEffect(() => {
                localStorage.setItem('my_pathway_data_v15', JSON.stringify(data));
            }, [data]);

            // --- PDF HELPERS ---
            const getTextFromPDF = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(" ") + "\n";
                }
                return fullText.replace(/\s+/g, ' '); 
            };

            // --- 1. TRANSCRIPT PARSER (Updated for Free Electives Consumed Logic) ---
            const parseTranscript = async (file) => {
                setIsProcessing(true);
                setProcessStatus("Reading Transcript...");
                try {
                    const text = await getTextFromPDF(file);
                    // Updated Regex: Handles 4-digit codes, 5-char codes (1905B), and suffix codes (SBMT6020G)
                    // Matches: "COMP 1021", "HMAW 1905B", "SBMT 6020G", "CORE BROAD"
                    const courseRegex = /([A-Z]{3,4})\s?(\d{4}[A-Z0-9]?|BROAD)/g;
                    
                    const newData = JSON.parse(JSON.stringify(data));
                    const consumedCourses = new Set(); // Track courses used for requirements
                    const updates = [];
                    
                    // 1. First Pass: Fulfill Explicit Requirements
                    let match;
                    while ((match = courseRegex.exec(text)) !== null) {
                        const code = `${match[1]} ${match[2]}`; // Normalized e.g., "SBMT 6020G"
                        const cleanCode = code.replace(/\s/g, ''); // "SBMT6020G"
                        
                        const window = text.substring(match.index, match.index + 100);
                        const gradeMatch = window.match(/\s([A-D][\+\-]?|F|T|P|PP|AU)(\s|$)/);
                        
                        if (gradeMatch) {
                            const grade = gradeMatch[1];
                            let status = (grade === 'PP') ? STATUS.IN_PROGRESS : STATUS.COMPLETED;
                            let matchedReq = false;

                            // Iterate all categories EXCEPT free electives to find matches
                            newData.categories.forEach(cat => {
                                if (cat.id === 'free_electives') return;
                                
                                cat.requirements.forEach(req => {
                                    // Already satisfied requirements shouldn't consume new courses unless it's an improvement
                                    // But here we simplify: check if this code fits this requirement
                                    
                                    const reqCodeClean = req.code ? req.code.replace(/\s/g, '') : '';
                                    
                                    // Direct Code Match
                                    if (reqCodeClean === cleanCode) {
                                        // Update the requirement
                                        req.status = status;
                                        req.grade = grade;
                                        matchedReq = true;
                                    } 
                                    // Alternative Match
                                    else if (req.alternatives) {
                                        const cleanAlts = req.alternatives.map(a => a.replace(/\s/g, ''));
                                        if (cleanAlts.includes(cleanCode)) {
                                            // Only consume if this requirement isn't already filled by something else
                                            // OR if this course IS the one that filled it
                                            if (!req.taken || req.taken.replace(/\s/g,'') === cleanCode) {
                                                req.status = status;
                                                req.grade = grade;
                                                req.taken = code;
                                                matchedReq = true;
                                            }
                                        }
                                    }
                                });
                            });

                            if (matchedReq) {
                                consumedCourses.add(cleanCode);
                                updates.push(`Requirement Met: ${code}`);
                            }
                        }
                    }

                    // 2. Second Pass: Populate Free Electives with Unconsumed Courses
                    // Reset regex to scan again
                    courseRegex.lastIndex = 0; 
                    const freeCat = newData.categories.find(c => c.id === 'free_electives');
                    // We don't wipe freeCat.requirements to avoid deleting manual entries, 
                    // but for transcript parsing we typically want a clean slate of detected extras. 
                    // Let's deduplicate instead.
                    
                    while ((match = courseRegex.exec(text)) !== null) {
                         const code = `${match[1]} ${match[2]}`;
                         const cleanCode = code.replace(/\s/g, '');
                         const window = text.substring(match.index, match.index + 100);
                         const gradeMatch = window.match(/\s([A-D][\+\-]?|F|T|P|PP|AU)(\s|$)/);

                         if (gradeMatch) {
                             const grade = gradeMatch[1];
                             let status = (grade === 'PP') ? STATUS.IN_PROGRESS : STATUS.COMPLETED;

                             // If NOT consumed and NOT "CORE BROAD" (placeholder), add to free electives
                             if (!consumedCourses.has(cleanCode) && cleanCode !== 'COREBROAD') {
                                 // Check if already in free electives to prevent dupes
                                 if (!freeCat.requirements.some(r => r.code.replace(/\s/g, '') === cleanCode)) {
                                     freeCat.requirements.push({
                                         id: `free_${cleanCode}`,
                                         name: "Free Elective / Extra",
                                         code: code,
                                         status: status,
                                         grade: grade,
                                         note: "Auto-detected from transcript"
                                     });
                                     updates.push(`Added Free Elective: ${code}`);
                                     consumedCourses.add(cleanCode); // prevent adding same course twice
                                 }
                             }
                         }
                    }
                    
                    setData(newData);
                    setReport({ title: "Transcript Processed", success: true, logs: updates.length ? updates : ["No changes detected."] });
                } catch(e) {
                    console.error(e);
                    setReport({ title: "Error", success: false, logs: ["Failed to parse transcript."] });
                } finally {
                    setIsProcessing(false);
                }
            };

            // ... (Catalog and Schedule parsers remain same) ...
            const parseCatalog = async (file) => {
                setIsProcessing(true); setProcessStatus("Updating DB...");
                try {
                    const text = await getTextFromPDF(file);
                    const newData = JSON.parse(JSON.stringify(data));
                    const catalogRegex = /([A-Z]{4})\s+(\d{4}[A-Z]?)\s+(.+?)(?=\s+\d+\s+Credit|\s+Previous|\s+Prerequisite)/g;
                    let match; let count = 0;
                    while ((match = catalogRegex.exec(text)) !== null) {
                        const subject = match[1]; const code = `${subject} ${match[2]}`; const title = match[3].replace(/(\d+ Credit.*)/, '').trim();
                        if (subject === 'COMP' || subject === 'FINA') {
                            const db = newData.courseCatalogs[subject];
                            let exists = false;
                            for (const cat in db) if (db[cat].some(c => c.code === code)) exists = true;
                            if (!exists) {
                                if (!db["New / Uncategorized"]) db["New / Uncategorized"] = [];
                                db["New / Uncategorized"].push({ code, name: title });
                                count++;
                            }
                        }
                    }
                    setData(newData); setReport({ title: "Catalog Update", success: true, logs: [`Added ${count} courses.`] });
                } catch(e) { setReport({ title: "Error", success: false, logs: ["Failed."] }); } finally { setIsProcessing(false); }
            };

            const parseSchedule = async (file) => {
                setIsProcessing(true); setProcessStatus("Analyzing Schedule...");
                try {
                    const text = await getTextFromPDF(file);
                    const newData = JSON.parse(JSON.stringify(data));
                    const scheduleRegex = /([A-Z]{4})\s+(\d{4}[A-Z]?)\s?-\s?([^(]+)/g;
                    const offeredSet = new Set(newData.offeredCourses || []);
                    let match; let count = 0;
                    while ((match = scheduleRegex.exec(text)) !== null) {
                        const code = `${match[1]} ${match[2]}`;
                        if (!offeredSet.has(code)) { offeredSet.add(code); count++; }
                    }
                    newData.offeredCourses = Array.from(offeredSet);
                    setData(newData);
                    setReport({ title: "Schedule Update", success: true, logs: [`Found ${count} new offered courses.`] });
                } catch(e) { setReport({ title: "Error", success: false, logs: ["Failed."] }); } finally { setIsProcessing(false); }
            };

            const handleFile = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                if (type === 'transcript') parseTranscript(file);
                else if (type === 'catalog') parseCatalog(file);
                else if (type === 'schedule') parseSchedule(file);
                e.target.value = null; 
            };

            // ... (Electives Explorer & Render Logic) ...
            
            const ElectivesExplorer = () => {
                const [showOfferedOnly, setShowOfferedOnly] = useState(false);
                const [search, setSearch] = useState("");
                const isOffered = (code) => data.offeredCourses && data.offeredCourses.includes(code);

                return (
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">Electives Explorer</h2>
                            <div className="flex gap-4 items-center bg-white p-2 rounded shadow-sm">
                                <label className="flex items-center gap-2 text-sm cursor-pointer select-none">
                                    <input type="checkbox" checked={showOfferedOnly} onChange={(e) => setShowOfferedOnly(e.target.checked)} className="rounded text-indigo-600" />
                                    <span>Show Only Offered</span>
                                </label>
                                <input type="text" placeholder="Search..." className="border rounded px-3 py-1 text-sm" value={search} onChange={e => setSearch(e.target.value)} />
                            </div>
                        </div>
                        <div className="grid md:grid-cols-2 gap-8">
                            {Object.entries(data.courseCatalogs).map(([subject, categories]) => (
                                <div key={subject} className="bg-white rounded-xl shadow p-6">
                                    <h3 className="text-xl font-bold mb-4 border-b pb-2">{subject} Electives</h3>
                                    {Object.entries(categories).map(([category, courses]) => {
                                        const visibleCourses = courses.filter(c => {
                                            const matchesSearch = c.name.toLowerCase().includes(search.toLowerCase()) || c.code.toLowerCase().includes(search.toLowerCase());
                                            const matchesOffer = showOfferedOnly ? isOffered(c.code) : true;
                                            return matchesSearch && matchesOffer;
                                        });
                                        if (visibleCourses.length === 0) return null;
                                        return (
                                            <div key={category} className="mb-6">
                                                <h4 className="font-semibold text-sm text-gray-500 uppercase mb-2">{category}</h4>
                                                <div className="space-y-2">
                                                    {visibleCourses.map(c => (
                                                        <div key={c.code} className="flex justify-between items-center p-2 rounded hover:bg-gray-50">
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-bold text-gray-800 text-sm">{c.code}</span>
                                                                {isOffered(c.code) && <span className="badge-offered">OFFERED</span>}
                                                                <span className="text-sm text-gray-600 truncate max-w-[200px]">{c.name}</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // Handlers
            const toggleStatus = (catId, reqId) => {
                const newData = { ...data };
                const req = newData.categories.find(c => c.id === catId).requirements.find(r => r.id === reqId);
                const cycle = [STATUS.NOT_STARTED, STATUS.PLANNED, STATUS.IN_PROGRESS, STATUS.COMPLETED];
                req.status = cycle[(cycle.indexOf(req.status) + 1) % cycle.length];
                setData(newData);
            };
            const handleDropdown = (catId, reqId, val) => {
                const newData = { ...data };
                const req = newData.categories.find(c => c.id === catId).requirements.find(r => r.id === reqId);
                req.selectedValue = val; req.code = val; req.status = val ? STATUS.PLANNED : STATUS.NOT_STARTED;
                setData(newData);
            };
            const handleTextChange = (catId, reqId, val) => {
                const newData = { ...data };
                const req = newData.categories.find(c => c.id === catId).requirements.find(r => r.id === reqId);
                req.selectedValue = val; req.code = val;
                setData(newData);
            };

            // Calculate Progress
            const stats = useMemo(() => {
                let total = 0, completed = 0;
                data.categories.forEach(c => c.requirements.forEach(r => {
                    if (c.id !== 'free_electives') total++; // Don't count free electives in denominator yet
                    if(r.status === STATUS.COMPLETED) completed++;
                }));
                return { percent: Math.round((completed/total)*100) };
            }, [data]);

            // CS Logic Visualizer
            const csAreaStats = useMemo(() => {
                const csCat = data.categories.find(c => c.id === "cs_electives");
                if (!csCat) return null;
                const counts = {};
                csCat.requirements.forEach(req => {
                    if (req.selectedValue) {
                        let foundArea = "Unknown";
                        for (const [area, courses] of Object.entries(data.courseCatalogs.COMP)) {
                             if (courses.some(c => c.code === req.selectedValue)) { foundArea = area; break; }
                        }
                        counts[foundArea] = (counts[foundArea] || 0) + 1;
                    }
                });
                const primaryArea = Object.entries(counts).find(([area, count]) => count >= 3 && area !== 'New / Uncategorized');
                const isPrimarySatisfied = !!primaryArea;
                let outsideCount = 0;
                if (primaryArea) Object.entries(counts).forEach(([area, count]) => { if (area !== primaryArea[0]) outsideCount += count; });
                const isSecondarySatisfied = outsideCount >= 2;
                return { counts, isPrimarySatisfied, isSecondarySatisfied, primaryAreaName: primaryArea ? primaryArea[0] : null };
            }, [data]);

            return (
                <div className="min-h-screen pb-12">
                    <div className="bg-white shadow-sm sticky top-0 z-20">
                        <div className="max-w-6xl mx-auto px-4 py-4">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                                <div>
                                    <h1 className="text-xl font-bold text-gray-800">{data.studentName}</h1>
                                    <p className="text-sm text-gray-500">DDP: BEng (COMP) & BBA (FINA) • ID: {data.studentId}</p>
                                </div>
                                <div className="flex gap-2 items-center flex-wrap justify-end">
                                    <label className="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg cursor-pointer flex items-center gap-2 transition shadow-sm">
                                        {isProcessing && processStatus.includes('Transcript') ? <div className="loader"></div> : <i className="fas fa-file-invoice"></i>}
                                        <span className="text-xs font-medium">Transcript</span>
                                        <input type="file" accept=".pdf" className="hidden" onChange={(e) => handleFile(e, 'transcript')} disabled={isProcessing} />
                                    </label>
                                    <label className="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg cursor-pointer flex items-center gap-2 transition shadow-sm">
                                        <i className="fas fa-book-open"></i> <span className="text-xs font-medium">Catalog</span>
                                        <input type="file" accept=".pdf" className="hidden" onChange={(e) => handleFile(e, 'catalog')} disabled={isProcessing} />
                                    </label>
                                    <label className="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg cursor-pointer flex items-center gap-2 transition shadow-sm">
                                        <i className="fas fa-calendar-alt"></i> <span className="text-xs font-medium">Schedule</span>
                                        <input type="file" accept=".pdf" className="hidden" onChange={(e) => handleFile(e, 'schedule')} disabled={isProcessing} />
                                    </label>
                                </div>
                            </div>
                            <div className="flex gap-8 border-b mt-4">
                                <button onClick={() => setActiveTab('tracker')} className={`pb-2 px-1 ${activeTab === 'tracker' ? 'tab-active' : 'tab-inactive'}`}>Pathway Tracker</button>
                                <button onClick={() => setActiveTab('electives')} className={`pb-2 px-1 ${activeTab === 'electives' ? 'tab-active' : 'tab-inactive'}`}>Electives Explorer</button>
                            </div>
                        </div>
                    </div>

                    {report && (
                        <div className="max-w-6xl mx-auto px-4 mt-6">
                            <div className={`p-4 rounded-lg border ${report.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                <div className="flex justify-between">
                                    <h3 className="font-bold">{report.title}</h3>
                                    <button onClick={() => setReport(null)}><i className="fas fa-times"></i></button>
                                </div>
                                <div className="mt-2 max-h-32 overflow-y-auto bg-white p-2 rounded text-xs font-mono">
                                    {report.logs.map((l, i) => <div key={i}>{l}</div>)}
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="max-w-6xl mx-auto px-4 mt-6">
                        {activeTab === 'electives' ? <ElectivesExplorer /> : (
                            <div className="grid gap-8">
                                {data.categories.map(cat => (
                                    <div key={cat.id} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                                        <div className={`px-6 py-4 border-b border-gray-100 ${cat.color} bg-opacity-30`}>
                                            <h2 className="text-lg font-bold">{cat.title}</h2>
                                            {cat.description && <p className="text-sm opacity-70">{cat.description}</p>}
                                        </div>
                                        
                                        {cat.id === "cs_electives" && csAreaStats && (
                                            <div className="px-6 py-2 bg-gray-50 border-b text-xs flex gap-4">
                                                <span className={csAreaStats.isPrimarySatisfied ? 'text-green-600 font-bold' : 'text-gray-500'}>
                                                    <i className={`fas ${csAreaStats.isPrimarySatisfied ? 'fa-check' : 'fa-circle'}`}></i> 3 from {csAreaStats.primaryAreaName || 'One Area'}
                                                </span>
                                                <span className={csAreaStats.isSecondarySatisfied ? 'text-green-600 font-bold' : 'text-gray-500'}>
                                                    <i className={`fas ${csAreaStats.isSecondarySatisfied ? 'fa-check' : 'fa-circle'}`}></i> 2 from Outside
                                                </span>
                                            </div>
                                        )}

                                        <div className="divide-y divide-gray-50">
                                            {cat.requirements.length === 0 && cat.id === 'free_electives' && (
                                                <div className="p-4 text-sm text-gray-400 italic">No extra courses detected yet. Upload a transcript to populate.</div>
                                            )}
                                            {cat.requirements.map(req => (
                                                <div key={req.id} className="p-4 hover:bg-gray-50 flex justify-between items-center gap-4">
                                                    <div className="flex-1">
                                                        {req.type === 'dropdown' ? (
                                                            <div className="flex items-center gap-2">
                                                                <select className="w-full max-w-md p-2 border rounded text-sm bg-transparent" 
                                                                    value={req.selectedValue || ""} 
                                                                    onChange={(e) => handleDropdown(cat.id, req.id, e.target.value)}>
                                                                    <option value="">-- Select Course --</option>
                                                                    {Object.entries(data.courseCatalogs[req.dbKey]).map(([area, courses]) => (
                                                                        <optgroup key={area} label={area}>
                                                                            {courses.map(c => {
                                                                                const isOffered = data.offeredCourses && data.offeredCourses.includes(c.code);
                                                                                return (
                                                                                    <option key={c.code} value={c.code} className={isOffered ? "font-bold text-green-700" : ""}>
                                                                                        {isOffered ? "✓ " : ""}{c.code} - {c.name}
                                                                                    </option>
                                                                                );
                                                                            })}
                                                                        </optgroup>
                                                                    ))}
                                                                </select>
                                                                {req.selectedValue && data.offeredCourses && data.offeredCourses.includes(req.selectedValue) && (
                                                                    <span className="badge-offered">OFFERED</span>
                                                                )}
                                                            </div>
                                                        ) : req.type === 'text_input' ? (
                                                            <div className="flex flex-col">
                                                                <span className="font-semibold text-gray-800 text-sm">{req.name}</span>
                                                                <input type="text" placeholder="Code" 
                                                                    className="border rounded px-2 py-1 text-xs mt-1 w-48"
                                                                    value={req.selectedValue || req.code || ""}
                                                                    onChange={(e) => handleTextChange(cat.id, req.id, e.target.value)}
                                                                />
                                                            </div>
                                                        ) : (
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-semibold text-gray-800">{req.code || (req.taken || req.alternatives?.[0] || req.name)}</span>
                                                                {req.grade && <span className="text-xs bg-gray-100 px-2 py-0.5 rounded border">Grade: {req.grade}</span>}
                                                                {!req.taken && req.alternatives && req.alternatives.some(alt => data.offeredCourses && data.offeredCourses.includes(alt)) && (
                                                                    <span className="badge-offered">Option Offered</span>
                                                                )}
                                                            </div>
                                                        )}
                                                        {req.alternatives && !req.taken && <div className="text-xs text-gray-500 mt-1">Options: {req.alternatives.join(", ")}</div>}
                                                        {req.note && <div className="text-xs text-blue-500 mt-1"><i className="fas fa-info-circle mr-1"></i> {req.note}</div>}
                                                    </div>
                                                    
                                                    <div className="cursor-pointer" onClick={() => toggleStatus(cat.id, req.id)}>
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center border-2 ${
                                                            req.status === STATUS.COMPLETED ? 'bg-green-500 text-white border-green-600' : 
                                                            req.status === STATUS.IN_PROGRESS ? 'bg-yellow-400 text-white border-yellow-500' : 
                                                            req.status === STATUS.PLANNED ? 'bg-blue-400 text-white border-blue-500' : 'bg-gray-100 text-gray-300'
                                                        }`}>
                                                            <i className={`fas ${req.status === STATUS.COMPLETED ? 'fa-check' : req.status === STATUS.IN_PROGRESS ? 'fa-spinner' : req.status === STATUS.PLANNED ? 'fa-calendar' : 'fa-circle'}`}></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    <div className="text-center text-gray-400 text-sm mt-12 mb-8">
                        <button onClick={() => { if(confirm("Reset all data?")) { localStorage.clear(); window.location.reload(); } }} className="text-red-400 underline">Reset All Data</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
